C51 COMPILER V9.52.0.0   MAIN                                                              12/20/2019 15:19:21 PAGE 1   


C51 COMPILER V9.52.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN main.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE main.c BROWSE DEBUG OBJECTEXTEND TABS(2)

line level    source

   1          /**********************************************************
   2           * 实验名称：思修SX-GPIO-KA模块测试实验（PAC9555）
   3           * 淘宝店铺：思修电子工作室
   4           * 店铺地址：https://520mcu.taobao.com/
   5           * 芯片型号：STC89C52RC
   6           * 时钟说明：芯片外部11.0592MHz
   7           * 接线说明：P3^7接到SX-GPIO-KA模块SDA引脚
   8                       P3^6接到SX-GPIO-KA模块SCL引脚
   9           * 模块地址：A0=0，A1=0，A2=0（模块正面短接焊盘已配置）
  10           * 测试现象：连接A、B端口的16个LED灯同时闪烁
  11          ***********************************************************/             
  12          #include <reg51.h> //头文件的包含         
  13          #include <intrins.h>
  14          /*******************常用数据类型定义**********************/
  15          #define u8  uint8_t
  16          #define u16 uint16_t
  17          #define u32 uint32_t
  18          typedef unsigned char  uint8_t;
  19          typedef unsigned int   uint16_t;
  20          typedef unsigned long  uint32_t;
  21          /**************************宏定义*************************/
  22          #define  _Nop()  _nop_()  //定义空指令
  23          #define  PCA9555  0x40    //PCA555地址 
  24          /******************端口/引脚定义区域**********************/
  25          sbit SDA=P3^7;            //模拟I2C数据传送位
  26          sbit SCL=P3^6;            //模拟I2C时钟控制位
  27          bit  ack;                 //应答标志位
  28          /********************函数声明区域*************************/
  29          void Delay_Ms(u16 ms);//毫秒延迟函数
  30          void Start_I2c(void); //IIC起动总线函数
  31          void Stop_I2c(void);  //IIC结束总线函数
  32          void SendByte(u8 c);  //IIC字节发送函数
  33          u8 RcvByte(void);     //IIC字节接收函数
  34          void Ack_I2c(bit a);  //IIC应答函数
  35          bit ISendByte(u8 sla,u8 c);//向无子地址器件发送字节数据函数
  36          bit ISendStr(u8 sla,u8 suba,u8 *s,u8 no);
  37          //向有子地址器件发送多字节数据函数
  38          bit IRcvByte(u8 sla,u8 *c);//向无子地址器件读字节数据函数
  39          bit IRcvStr(u8 sla,u8 suba,u8 *s,u8 no);
  40          //向有子地址器件接收多字节数据函数
  41          /*********************主函数区域**************************/
  42          void main(void)
  43          {
  44   1        u8 buff1[1]={0x00};//设置输出结构端口状态数组
  45   1        u8 buff2[1]={0xFF};//设置I/O端口状态数组2
  46   1        u8 buff3[1]={0x00};//设置I/O端口状态数组3
  47   1        ISendStr(PCA9555,0x06,buff1,1);//配置输出结构端口寄存器0
  48   1        ISendStr(PCA9555,0x07,buff1,1);//配置输出结构端口寄存器1
  49   1        while(1)
  50   1        {
  51   2          ISendStr(PCA9555,0x02,buff2,1); //A端口推挽输出高电平
  52   2          ISendStr(PCA9555,0x03,buff2,1); //B端口推挽输出高电平
  53   2          Delay_Ms(100);                  //延迟100ms
  54   2          ISendStr(PCA9555,0x02,buff3,1); //A端口推挽输出低电平
  55   2          ISendStr(PCA9555,0x03,buff3,1); //B端口推挽输出低电平
C51 COMPILER V9.52.0.0   MAIN                                                              12/20/2019 15:19:21 PAGE 2   

  56   2          Delay_Ms(100);                  //延迟100ms   
  57   2        }
  58   1      }
  59          /***************************************************************
  60          起动总线函数Start_I2c(void)，无形参,无返回值
  61          ***************************************************************/
  62          void Start_I2c(void)
  63          {
  64   1        SDA=1;    //发送起始条件的数据信号
  65   1        _Nop();
  66   1        SCL=1;
  67   1        _Nop();   //起始条件建立时间大于4.7us,延时
  68   1        _Nop();
  69   1        _Nop();
  70   1        _Nop();
  71   1        _Nop();    
  72   1        SDA=0;    //发送起始信号
  73   1        _Nop();   //起始条件锁定时间大于4μs
  74   1        _Nop();
  75   1        _Nop();
  76   1        _Nop();
  77   1        _Nop();       
  78   1        SCL=0;   //钳住I2C总线，准备发送或接收数据 
  79   1        _Nop();
  80   1        _Nop();
  81   1      }   
  82          /***************************************************************
  83          结束总线函数 Stop_I2c(void)，无形参,无返回值
  84          ***************************************************************/
  85          void Stop_I2c(void)
  86          {
  87   1        SDA=0;   //发送结束条件的数据信号
  88   1        _Nop();  //发送结束条件的时钟信号
  89   1        SCL=1;   //结束条件建立时间大于4μs
  90   1        _Nop();
  91   1        _Nop();
  92   1        _Nop();
  93   1        _Nop();
  94   1        _Nop();
  95   1        SDA=1;   //发送I2C总线结束信号
  96   1        _Nop();
  97   1        _Nop();
  98   1        _Nop();
  99   1        _Nop();
 100   1      }
 101          /***************************************************************
 102          IIC字节数据传送函数SendByte(u8 c)，有形参c,无返回值
 103          ***************************************************************/
 104          void  SendByte(u8 c)
 105          {
 106   1        u8 BitCnt;
 107   1        for(BitCnt=0;BitCnt<8;BitCnt++)
 108   1        {
 109   2          //要传送的数据长度为8位
 110   2          if((c<<BitCnt)&0x80)
 111   2            SDA=1;     //判断发送位
 112   2          else  
 113   2            SDA=0;                
 114   2          _Nop();
 115   2          SCL=1;      //置时钟线为高，通知被控器开始接收数据位
 116   2          _Nop(); 
 117   2          _Nop();     //保证时钟高电平周期大于4μs
C51 COMPILER V9.52.0.0   MAIN                                                              12/20/2019 15:19:21 PAGE 3   

 118   2          _Nop();
 119   2          _Nop();
 120   2          _Nop();         
 121   2          SCL=0; 
 122   2        }
 123   1        _Nop();
 124   1        _Nop();
 125   1        SDA=1;        //8位发送完后释放数据线，准备接收应答位
 126   1        _Nop();
 127   1        _Nop();   
 128   1        SCL=1;
 129   1        _Nop();
 130   1        _Nop();
 131   1        _Nop();
 132   1        if(SDA==1)
 133   1          ack=0;     
 134   1        else 
 135   1          ack=1;      //判断是否接收到应答信号
 136   1        SCL=0;
 137   1        _Nop();
 138   1        _Nop();
 139   1      }
 140          /***************************************************************
 141          IIC字节数据接收函数RcvByte(void)，无形参,有返回值retc
 142          ***************************************************************/
 143          u8  RcvByte(void)
 144          {
 145   1        u8 retc;
 146   1        u8 BitCnt;
 147   1        retc=0; 
 148   1        SDA=1;       //置数据线为输入方式
 149   1        for(BitCnt=0;BitCnt<8;BitCnt++)
 150   1        {
 151   2          _Nop();           
 152   2          SCL=0;          //置时钟线为低，准备接收数据位
 153   2          _Nop();
 154   2          _Nop();         //时钟低电平周期大于4.7μs
 155   2          _Nop();
 156   2          _Nop();
 157   2          _Nop();
 158   2          SCL=1;          //置时钟线为高使数据线上数据有效
 159   2          _Nop();
 160   2          _Nop();
 161   2          retc=retc<<1;
 162   2          if(SDA==1)
 163   2            retc=retc+1;  //读数据位,接收的数据位放入retc中
 164   2          _Nop();
 165   2          _Nop(); 
 166   2        }
 167   1        SCL=0;    
 168   1        _Nop();
 169   1        _Nop();
 170   1        return(retc);
 171   1      }
 172          /***************************************************************
 173          IIC应答子函数Ack_I2c(bit a)，有形参a,无返回值
 174          ***************************************************************/
 175          void Ack_I2c(bit a)
 176          {
 177   1        if(a==0)
 178   1          SDA=0;     //在此发出应答或非应答信号 
 179   1        else 
C51 COMPILER V9.52.0.0   MAIN                                                              12/20/2019 15:19:21 PAGE 4   

 180   1          SDA=1;
 181   1        _Nop();
 182   1        _Nop();
 183   1        _Nop();      
 184   1        SCL=1;
 185   1        _Nop();
 186   1        _Nop();     //时钟低电平周期大于4μs
 187   1        _Nop();
 188   1        _Nop();
 189   1        _Nop();  
 190   1        SCL=0;     //清时钟线，钳住I2C总线以便继续接收*/
 191   1        _Nop();
 192   1        _Nop();    
 193   1      } 
 194          /***************************************************************
 195          向无子地址器件发送字节数据函数 ISendByte(u8 sla,u8 c)
 196          有形参sla:地址；c：发送数据；无返回值
 197          ***************************************************************/
 198          bit ISendByte(u8 sla,u8 c)
 199          {
 200   1        Start_I2c();         //启动总线
 201   1        SendByte(sla);       //发送器件地址
 202   1        if(ack==0)
 203   1          return(0);
 204   1        SendByte(c);         //发送数据
 205   1        if(ack==0)
 206   1          return(0);
 207   1        Stop_I2c();          //结束总线 
 208   1        return(1);
 209   1      } 
 210          /***************************************************************
 211          向有子地址器件发送多字节数据函数ISendStr(u8 sla,u8 suba,u8 *s,u8 no)
 212          有形参sla:地址；suba：子地址；*s：数据数组；no：字节个数；有返回值1
 213          ***************************************************************/
 214          bit ISendStr(u8 sla,u8 suba,u8 *s,u8 no)
 215          {
 216   1        u8 i;
 217   1        Start_I2c();         //启动总线
 218   1        SendByte(sla);       //发送器件地址
 219   1        if(ack==0)
 220   1          return(0);
 221   1        SendByte(suba);      //发送器件子地址
 222   1        if(ack==0)
 223   1          return(0);
 224   1        for(i=0;i<no;i++)
 225   1        {   
 226   2          SendByte(*s);       //发送数据
 227   2          if(ack==0)return(0);
 228   2          s++;
 229   2        }
 230   1        Stop_I2c();          //结束总线
 231   1        return(1);
 232   1      } 
 233          /***************************************************************
 234          向无子地址器件读字节数据函数IRcvByte(u8 sla,u8 *c)
 235          有形参sla:地址；suba：发送数据；*c：；有返回值1
 236          ***************************************************************/
 237          bit IRcvByte(u8 sla,u8 *c)
 238          {
 239   1        Start_I2c();        //启动总线
 240   1        SendByte(sla+1);    //发送器件地址
 241   1        if(ack==0)
C51 COMPILER V9.52.0.0   MAIN                                                              12/20/2019 15:19:21 PAGE 5   

 242   1          return(0);
 243   1        *c=RcvByte();       //读取数据
 244   1        Ack_I2c(1);         //发送非就答位
 245   1        Stop_I2c();         //结束总线
 246   1        return(1);
 247   1      } 
 248          /***************************************************************
 249          向有子地址器件接收多字节数据函数IRcvStr(u8 sla,u8 suba,u8 *s,u8 no)
 250          有形参sla:地址；suba：子地址；*s：数据数组；no：字节个数；有返回值1
 251          ***************************************************************/
 252          bit IRcvStr(u8 sla,u8 suba,u8 *s,u8 no)
 253          {
 254   1        u8 i;
 255   1        Start_I2c();           //启动总线
 256   1        SendByte(sla);         //发送器件地址
 257   1        if(ack==0)
 258   1          return(0);
 259   1        SendByte(suba);        //发送器件子地址
 260   1        if(ack==0)
 261   1          return(0);  
 262   1        Start_I2c();
 263   1        SendByte(sla+1);
 264   1        if(ack==0)
 265   1          return(0);
 266   1        for(i=0;i<no-1;i++)
 267   1        {   
 268   2          *s=RcvByte();       //发送数据
 269   2          Ack_I2c(0);         //发送就答位 
 270   2          s++;
 271   2        } 
 272   1        *s=RcvByte();
 273   1        Ack_I2c(1);          //发送非应位
 274   1        Stop_I2c();          //结束总线 
 275   1        return(1);
 276   1      }
 277          /***************************************************************
 278          毫秒延迟函数Delay_Ms(u16 ms)
 279          有形参ms:毫秒参数；无返回值
 280          ***************************************************************/
 281          void Delay_Ms(u16 ms)
 282          {
 283   1        u16 us;
 284   1        for(;ms>0;ms--)
 285   1          for(us=200;us>0;us--);
 286   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    539    ----
   CONSTANT SIZE    =      3    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----      15
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1       1
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
